---
title: "Redis逻辑多租"
permalink: /redis
---



# Redis逻辑多租

Redis Logical multi-tenancy

## 调查分析

[caching - Multi Tenancy in Redis for node.js - Stack Overflow](https://stackoverflow.com/questions/45053355/multi-tenancy-in-redis-for-node-js?rq=3)

1. 性能问题：Redis单线程，一个租户的操作可能阻塞其他租户操作。
   * 每个租户专用Redis线程（或代理层）
   * 直接使用KeyDB

2. 连接数问题：超过65535？

## RedisLab逻辑多租

[Multi-Tenancy in Redis Enterprise - Redis](https://redis.io/blog/multi-tenancy-redis-enterprise/)

### 逻辑多租架构介绍

多租户架构是一个单体服务（通常是部署一个集群或分布式系统，而不是多套）同时提供多个直接用户组或租户。每个租户的数据是安全隔离的，需要保证数据对其他租户不可见和不可访问。打个比喻，就像小区单元楼，每个业主独享一个房间，但是所有房间都在一套楼里。

逻辑多租会带来运维效率和成本效益等优势。这是因为不用为每个租户提供额外的物理基础设施（iaas），提供最大资源利用率。从而降低了成本。

多租户与多实例有显著的区别。多实例架构中，需要为每个租户安装一个Redis实例。随着租户增长，需要管理更多的实例，安装、部署、监控、运维成本复杂的增大。

### 通过虚拟化或容器化实现多租户

在这种场景下，Redis部署在一个容器或一个虚机中，底层管理系统（k8s）负责根据需要启动新的Redis实例。

多租户在服务器或基础资源层实现，保证每个租户的操作独立和安全。这种方法非常类似于多实例架构，尽管简化了管理层提供的配置和启动新的 Redis 服务的流程，但需要监控和管理的 Redis 实例的数量保持不变。

### 通过逻辑方式实现多租户

Redis提供了软件形式多租户，部署一套Redis集群，高效率支撑成百上千租户。每个租户被分配到独一无二的Redis节点（端），来保证完全的数据隔离。

![cluster of nodes](https://redis.io/wp-content/uploads/2024/05/Multi-tenancy-blog_Page_4_Image_0001.jpg?&auto=webp&quality=85,75&width=800)

在数据中心、私有云或虚拟私有云中部署 Redis 可充分利用我们多租户架构的经济优势。只需一个包含几个 Redis 节点的集群，可以支持从开发和测试到全面生产的一系列活动。此设置可高效地满足同一基础设施中不同租户的不同需求。

### Redis逻辑多租如何实现

我们的架构采用多层抽象，以实现多租户、高可用性、线性扩展和高吞吐量等功能。以下是主要组件的细分：

#### Node节点

节点是 Redis 软件运行的硬件基础（物理服务器、虚拟机、容器或云实例）。

#### 数据平面

分片Shard：Redis 的核心是分片，它是运行在单个 CPU 核心上的 Redis 核心实例。它管理整个数据集的子集，独立运行以提高性能和可扩展性。

数据库Database：每个数据库都充当租户数据的逻辑端点。您可以根据数据大小和吞吐量需求为数据库分配多个分片。持久性、复制、驱逐策略以及使用闪存扩展 RAM 等功能可以在数据库级别配置。数据库通过将主数据库和辅助数据库分布在不同节点上来确保高可用性。数据库的类型包括：

* 简单数据库：单个主分片
* 高可用性 (HA) 数据库：一个主分片和一个或多个副本分片
* 集群数据库：多个主分片，每个分片处理数据集的一部分
* HA 集群数据库：多对主分片和副本分片

![databases](https://redis.io/wp-content/uploads/2024/05/Multi-tenancy-blog_Page_5_Image_0001.jpg?&auto=webp&quality=85,75&width=800)

#### 管理平面

零延迟代理：此多线程代理集成到每个节点中，将客户端的 Redis 操作路由到正确的数据库分片。它确保请求被定向到适当的分片，从而保持高效运行。

集群管理器：此组件由一组分布式进程组成，用于管理整个集群生命周期。集群管理器与数据路径组件分开，负责：

* 数据库配置和取消配置：确保最佳资源利用率
* 自动扩展：调整资源以处理峰值工作负载
* 自动重新分片：确保高吞吐量和低延迟性能
* 自动重新平衡：保持高吞吐量和实时性能
* 资源管理：监控整个系统的运行状况
* 节点看门狗：监督每个 Redis 节点上的进程，必要时触发分片故障事件
* 集群看门狗：确保 Redis 集群节点的运行状况，根据需要触发节点故障事件

![cluster paths](https://redis.io/wp-content/uploads/2024/05/Multi-tenancy-blog_Page_6_Image_0001.jpg?&auto=webp&quality=85,75&width=800)

部署功能非常丰富，唯一的限制是整个集群中可用的总内存。每个数据库端点都分配有一个完全限定域名 (FQDN)，所有节点上的零延迟代理可高效地将客户端请求重定向到正确的主分片。

### 利用多租户降低成本并提高工作效率

在3节点集群上运行上百个数据库终端节点。一个Redis节点上运行多个数据库终端。

Redis节点与数据库终端是1：n关系。

无缝扩容：添加分配并扩展到多个节点，从而扩展Redis数据库。（看着数据库是多个分片的集合），比如把1到10号分片给定义为数据库1。或者直接1个分片叫一个数据库。（Redis集群模式不支持多DB，只有一个db可用，但是有16384个分片可用）

多DB底层持久化都在相同的RDB或AOF文件（一个）

**性能**：我们的架构允许数据路径实体专注于处理用户请求，从而提高整体性能。每个分片都独立运行，类似于独立的 Redis 实例，无需监控其他实例或管理网络分区，这种隔离可以最大限度地减少来自其他租户的“噪音”。

**可用性**：应用程序在分片、重新分片和再平衡活动期间保持对数据的一致访问。这种无缝的数据可用性是自动管理的，无需人工干预，并确保在后台活动的情况下作不会中断。

**安全性和数据隐私**：Redis 通过将配置命令限制为具有基于角色的授权的安全 CLI、UI 或 API 接口来增强安全性。我们基于代理的架构确保每个分片仅与经过身份验证的实体连接并处理经过验证的请求，防止未经授权的访问，并增强租户之间的数据隐私。

**可管理性**：数据库预置、配置更改和软件更新等管理任务通过单个命令简化，并通过 UI 或 API 执行。这些任务在集群中执行，不会中断用户流量，确保平稳运行和有效分配资源。

**可扩展性和资源分配**：该架构支持水平可扩展性，可在多个节点、服务器和集群之间有效地分配数据集。这种方法不仅可以适应增长，还可以战略性地分配资源，以防止任何单个租户垄断系统功能。结果如何？所有租户之间的资源分配公平。

安全：Redis 还部署了安全措施来防止潜在的违规行为。这包括强大的访问控制、定期安全审计和最新的加密标准，以保护传输中的数据和静态数据。这为企业提供了额外的保证层，并有助于维护对多租户设置的信任。
